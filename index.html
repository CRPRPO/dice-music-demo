<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dice Music Chord Prototype (Hand Control)</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
    }
    #webcam {
      position: fixed;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: 0;
    }
    #canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1;
    }
    .overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
    }
    h1 {
      position: absolute;
      width: 100%;
      text-align: center;
      color: white;
      top: 10px;
      z-index: 3;
    }
    .music-block {
      width: 80px;
      height: 80px;
      background: #4caf50;
      position: absolute;
      border-radius: 10px;
      box-shadow: 0 0 8px #4caf50;
      cursor: grab;
      text-align: center;
      line-height: 80px;
      font-size: 24px;
      z-index: 3;
    }
    .drop-zone {
      width: 100px;
      height: 100px;
      background: #555;
      border: 2px dashed white;
      position: absolute;
      border-radius: 15px;
      z-index: 3;
    }
  </style>
</head>
<body>
  <!-- ðŸ“· æ”å½±æ©Ÿç•«é¢ä½œç‚ºèƒŒæ™¯ -->
  <video id="webcam" autoplay muted playsinline></video>
  <!-- ðŸŽ¨ æ‰‹éƒ¨éª¨æž¶ canvas -->
  <canvas id="canvas"></canvas>

  <!-- ðŸ§± ä¸Šå±¤äº’å‹•å€åŸŸ -->
  <div class="overlay">
    <h1>Dice Music - Hand Controlled Blocks</h1>
    <div class="music-block" id="block1" style="top: 120px; left: 20%;">1</div>
    <div class="music-block" id="block2" style="top: 120px; left: 35%;">2</div>
    <div class="music-block" id="block3" style="top: 120px; left: 50%;">3</div>
    <div class="music-block" id="block4" style="top: 220px; left: 20%;">4</div>
    <div class="music-block" id="block5" style="top: 220px; left: 35%;">5</div>
    <div class="music-block" id="block6" style="top: 220px; left: 50%;">6</div>

    <div class="drop-zone" id="drop1" style="top: 400px; left: 25%;"></div>
    <div class="drop-zone" id="drop2" style="top: 400px; left: 45%;"></div>
    <div class="drop-zone" id="drop3" style="top: 400px; left: 65%;"></div>
  </div>

  <!-- ðŸ“š å¤–éƒ¨å‡½å¼åº« -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.min.js"></script>

  <script>
    const chords = {
      block1: ["C4", "E4", "G4"],
      block2: ["D4", "F4", "A4"],
      block3: ["E4", "G4", "B4"],
      block4: ["F4", "A4", "C5"],
      block5: ["G4", "B4", "D5"],
      block6: ["A4", "C5", "E5"]
    };

    const videoElement = document.getElementById('webcam');
    const canvasElement = document.getElementById('canvas');
    const canvasCtx = canvasElement.getContext('2d');

    const hands = new Hands({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });
    hands.setOptions({
      maxNumHands: 1,
      modelComplexity: 1,
      minDetectionConfidence: 0.7,
      minTrackingConfidence: 0.7
    });
    hands.onResults(onResults);

    const camera = new Camera(videoElement, {
      onFrame: async () => await hands.send({ image: videoElement }),
      width: 640,
      height: 480
    });
    camera.start();

    let currentBlock = null;
    let dragging = false;

    function onResults(results) {
      // ðŸ§¼ æ¸…é™¤å‰ä¸€å¹€
      canvasElement.width = window.innerWidth;
      canvasElement.height = window.innerHeight;
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

      // ðŸŽ¨ ç¹ªè£½éª¨æž¶
      if (results.multiHandLandmarks) {
        for (const landmarks of results.multiHandLandmarks) {
          drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, { color: '#00FF00', lineWidth: 3 });
          drawLandmarks(canvasCtx, landmarks, { color: '#FF0000', radius: 5 });
        }
      }

      if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) return;
      const hand = results.multiHandLandmarks[0];
      const [x, y] = [hand[9].x * window.innerWidth, hand[9].y * window.innerHeight];

      document.querySelectorAll('.music-block').forEach(block => {
        const rect = block.getBoundingClientRect();
        const inside = x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom;

        if (inside && results.multiHandedness[0].label === 'Right') {
          const fingerExtended = hand[8].y < hand[6].y;
          const isFist = hand[8].y > hand[6].y && hand[12].y > hand[10].y;

          if (fingerExtended && !dragging) {
            Tone.start();
            new Tone.PolySynth().toDestination().triggerAttackRelease(chords[block.id], "8n");
          } else if (!dragging && !isFist) {
            currentBlock = block;
            dragging = true;
          }
        }
      });

      if (dragging && currentBlock) {
        currentBlock.style.left = `${x - currentBlock.offsetWidth / 2}px`;
        currentBlock.style.top = `${y - currentBlock.offsetHeight / 2}px`;
      }

      if (dragging && currentBlock && hand[8].y > hand[6].y && hand[12].y > hand[10].y) {
        checkDropZone(currentBlock);
        dragging = false;
        currentBlock = null;
      }
    }

    function checkDropZone(block) {
      const blockRect = block.getBoundingClientRect();
      document.querySelectorAll('.drop-zone').forEach(zone => {
        const zoneRect = zone.getBoundingClientRect();
        const isInZone = !(
          blockRect.right < zoneRect.left ||
          blockRect.left > zoneRect.right ||
          blockRect.bottom < zoneRect.top ||
          blockRect.top > zoneRect.bottom
        );
        if (isInZone) {
          Tone.start();
          new Tone.PolySynth().toDestination().triggerAttackRelease(chords[block.id], "2n");
          zone.style.borderColor = "#4caf50";
          setTimeout(() => zone.style.borderColor = "white", 300);
        }
      });
    }
  </script>
</body>
</html>
