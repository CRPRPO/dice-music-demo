<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dice Music - Mirror Tap Test</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    #webcam {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      transform: scaleX(-1); /* üîÅ Èè°ÂÉèÈ°ØÁ§∫ */
      z-index: 0;
    }
    canvas {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
      pointer-events: none;
    }
    .block {
      position: absolute;
      width: 80px;
      height: 80px;
      background: #4caf50;
      color: white;
      font-size: 24px;
      font-weight: bold;
      border-radius: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2;
    }
    .zone {
      position: absolute;
      width: 100px;
      height: 100px;
      background: #555;
      border: 2px dashed white;
      border-radius: 10px;
      z-index: 2;
    }
  </style>
</head>
<body>
  <video id="webcam" autoplay muted playsinline></video>
  <canvas id="canvas"></canvas>

  <div class="block" id="musicBlock" style="top: 100px; left: 50px;">üéµ</div>
  <div class="zone" style="bottom: 50px; left: 20%;"></div>
  <div class="zone" style="bottom: 50px; left: 45%;"></div>
  <div class="zone" style="bottom: 50px; left: 70%;"></div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.min.js"></script>

  <script>
    const webcamElement = document.getElementById('webcam');
    const canvasElement = document.getElementById('canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const musicBlock = document.getElementById('musicBlock');
    const synth = new Tone.PolySynth().toDestination();

    function resizeCanvas() {
      canvasElement.width = window.innerWidth;
      canvasElement.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    const hands = new Hands({
      locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });
    hands.setOptions({
      maxNumHands: 1,
      modelComplexity: 1,
      minDetectionConfidence: 0.7,
      minTrackingConfidence: 0.7
    });

    hands.onResults(results => {
      canvasCtx.save();
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
      if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        const landmarks = results.multiHandLandmarks[0];
        drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, { color: '#00FF00', lineWidth: 2 });
        drawLandmarks(canvasCtx, landmarks, { color: '#FF0000', lineWidth: 1 });

        const indexTip = landmarks[8];
        const x = (1 - indexTip.x) * window.innerWidth; // üîÅ Èè°ÂÉèËΩâÊèõ
        const y = indexTip.y * window.innerHeight;

        const rect = musicBlock.getBoundingClientRect();
        const within = x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom;
        if (within) {
          Tone.start();
          synth.triggerAttackRelease(["C4", "E4", "G4"], "8n");
        }
      }
      canvasCtx.restore();
    });

    const camera = new Camera(webcamElement, {
      onFrame: async () => {
        await hands.send({ image: webcamElement });
      },
      width: 640,
      height: 480
    });
    camera.start();
  </script>
</body>
</html>
