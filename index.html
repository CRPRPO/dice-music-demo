<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dice Music - Drag with Fist (Optimized)</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    #webcam {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      transform: scaleX(-1);
      z-index: 0;
    }
    canvas {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
      pointer-events: none;
      transform: scaleX(-1);
    }
    .block {
      position: absolute;
      width: 80px;
      height: 80px;
      background: #4caf50;
      color: white;
      font-size: 24px;
      font-weight: bold;
      border-radius: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2;
      left: calc(50% - 40px);
      top: 120px;
    }
    .zone {
      position: absolute;
      width: 100px;
      height: 100px;
      background: #555;
      border: 2px dashed white;
      border-radius: 10px;
      z-index: 2;
    }
  </style>
</head>
<body>
  <video id="webcam" autoplay muted playsinline></video>
  <canvas id="canvas"></canvas>
  <div class="block" id="musicBlock">🎵</div>
  <div class="zone" style="bottom: 50px; left: 20%;"></div>
  <div class="zone" style="bottom: 50px; left: 45%;"></div>
  <div class="zone" style="bottom: 50px; left: 70%;"></div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

  <script>
    const webcamElement = document.getElementById('webcam');
    const canvasElement = document.getElementById('canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const musicBlock = document.getElementById('musicBlock');

    function resizeCanvas() {
      canvasElement.width = window.innerWidth;
      canvasElement.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    const hands = new Hands({
      locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });
    hands.setOptions({
      maxNumHands: 1,
      modelComplexity: 1,
      minDetectionConfidence: 0.7,
      minTrackingConfidence: 0.7
    });

    let dragging = false;
    let offsetX = 0;
    let offsetY = 0;

    hands.onResults(results => {
      canvasCtx.save();
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

      if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        const landmarks = results.multiHandLandmarks[0];
        drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, { color: '#00FF00', lineWidth: 2 });
        drawLandmarks(canvasCtx, landmarks, { color: '#FF0000', lineWidth: 1 });

        const xScale = window.innerWidth;
        const yScale = window.innerHeight;

        const tipDistance = (a, b) => {
          const dx = a.x - b.x;
          const dy = a.y - b.y;
          return Math.sqrt(dx * dx + dy * dy);
        };

        // ✅ 判斷是否為握拳（只判斷食指、中指、無名指、小指）
        const curled = [8, 12, 16, 20].every((tip, i) => {
          const pip = tip - 2;
          return landmarks[tip].y > landmarks[pip].y;
        });

        const palm = landmarks[0];
        const px = (1 - palm.x) * xScale;
        const py = palm.y * yScale;

        if (curled) {
          if (!dragging) {
            // 初始進入拖曳狀態時記錄相對位置
            const rect = musicBlock.getBoundingClientRect();
            offsetX = px - rect.left;
            offsetY = py - rect.top;
            dragging = true;
          }
          // 拖曳中：更新綠色方塊位置
          musicBlock.style.left = `${px - offsetX}px`;
          musicBlock.style.top = `${py - offsetY}px`;
        } else {
          dragging = false;
        }
      }

      canvasCtx.restore();
    });

    const camera = new Camera(webcamElement, {
      onFrame: async () => {
        await hands.send({ image: webcamElement });
      },
      width: 640,
      height: 480
    });
    camera.start();
  </script>
</body>
</html>
